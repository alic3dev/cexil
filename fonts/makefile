PROJECT_NAME=cexil_fonts_compilation

CEXIL_FONT_EXTENSION=cexil_font

OUT_DIRECTORY=transpiled_fonts

CEXIL_FONT_FILES=$(wildcard *.$(CEXIL_FONT_EXTENSION))
CEXIL_FONT_OUT_DIRECTORIES=$(patsubst %.$(CEXIL_FONT_EXTENSION), $(OUT_DIRECTORY)/%, $(CEXIL_FONT_FILES))

CEXIL_FONT_TRANSPILER_DIRECTORY=cexil_font_transpiler
CEXIL_FONT_TRANSPILER_BINARY_DIRECTORY=bin
CEXIL_FONT_TRANSPILER_BINARY_NAME=cexil_font_transpiler
CEXIL_FONT_TRANSPILER_BINARY_PATH=$(CEXIL_FONT_TRANSPILER_DIRECTORY)/$(CEXIL_FONT_TRANSPILER_BINARY_DIRECTORY)/$(CEXIL_FONT_TRANSPILER_BINARY_NAME)

CEXIL_FONT_OBJECTS_DIRECTORY=$(OUT_DIRECTORY)/objects
CEXIL_FONT_INCLUDE_DIRECTORY=$(OUT_DIRECTORY)/include/fonts

CEXIL_INCLUDE_DIRECTORY=../include

CC=gcc
C_FLAGS=-O3 -I$(CEXIL_INCLUDE_DIRECTORY) -Wno-gnu-designator
LD=ld
LD_FLAGS=

all: $(CEXIL_FONT_OUT_DIRECTORIES)
	-rm $(CEXIL_FONT_OBJECTS_DIRECTORY)/$(PROJECT_NAME).o 2> /dev/null
	$(LD) $(LD_FLAGS) -r $(CEXIL_FONT_OBJECTS_DIRECTORY)/*.o -o $(CEXIL_FONT_OBJECTS_DIRECTORY)/$(PROJECT_NAME).o

$(OUT_DIRECTORY)/%: %.$(CEXIL_FONT_EXTENSION) $(CEXIL_FONT_TRANSPILER_BINARY_NAME)
	$(CEXIL_FONT_TRANSPILER_BINARY_PATH) $< $(OUT_DIRECTORY)
	mkdir -p $(CEXIL_FONT_OBJECTS_DIRECTORY)
	ls -R $(OUT_DIRECTORY)
	$(CC) $(C_FLAGS) -I$(OUT_DIRECTORY)/$(patsubst %.$(CEXIL_FONT_EXTENSION),%,$<)/include  -c $(OUT_DIRECTORY)/$(patsubst %.$(CEXIL_FONT_EXTENSION),%,$<)/sources/*.c -o $(CEXIL_FONT_OBJECTS_DIRECTORY)/$(patsubst %.$(CEXIL_FONT_EXTENSION),%,$<).o
	mkdir -p $(CEXIL_FONT_INCLUDE_DIRECTORY)
	ln -s ../../../$(OUT_DIRECTORY)/$(patsubst %.$(CEXIL_FONT_EXTENSION),%,$<)/include $(CEXIL_FONT_INCLUDE_DIRECTORY)/$(patsubst %.$(CEXIL_FONT_EXTENSION),%,$<)

$(CEXIL_FONT_TRANSPILER_BINARY_NAME): .FORCE
	cd $(CEXIL_FONT_TRANSPILER_DIRECTORY) && make

clean:
	-rm -r $(OUT_DIRECTORY) 2> /dev/null

clean_$(CEXIL_FONT_TRANSPILER_BINARY_NAME):
	cd $(CEXIL_FONT_TRANSPILER_DIRECTORY) && make clean

clean_all: clean clean_$(CEXIL_FONT_TRANSPILER_BINARY_NAME)

.FORCE:

